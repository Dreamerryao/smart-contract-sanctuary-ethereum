// SPDX-License-Identifier: MIT
pragma solidity >=0.8.12 <0.9.0;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/ERC721/utils/ERC721Holder.sol";

// The NFT that can be staked here.
interface IPPASurrealestates {
    function transferFrom(
        address from,
        address to,
        uint256 tokenId
    ) external;

    function ownerOf(uint256 tokenId) external view returns (address);
}

// A listening contract can implement this function to get notified any time a user stakes or unstakes.
interface IStakingListener {
    function notifyChange(address account) external;
}

contract SurrealestateStaking is ERC721Holder, Ownable {
    IPPASurrealestates surrealestates;
    address surrealestateContractAddress;

    constructor() public {
        surrealestateContractAddress = _getSurrealestatesContractAddress();
        surrealestates = IPPASurrealestates(surrealestateContractAddress);
    }

    function _getSurrealestatesContractAddress()
        internal
        view
        returns (address)
    {
        address addr;
        assembly {
            switch chainid()
            case 1 {
                // mainnet
                addr := 0x6f3185b51a42e03a4f0eaaf37604ddd499ef9b12
            }
            case 4 {
                // rinkeby
                addr := 0x6551111b5d3C7e4B5436409C2e70A8Fbe1757407
            }
        }
        return addr;
    }

    // The period which people can lock their funds up for to get an extra multiplier on rewards earned.
    uint256 stakingLockPeriod = 7776000; // 90 days in seconds.

    struct StakingMultiplier {
        uint256 numeratorMinus1; // Store as "minus 1" because we want this to default to 1, but uninitialized vars default to 0.
        uint256 denominatorMinus1;
    }

    struct AccountInfo {
        uint256 numStaked;
        uint256 pointsStaked;
        uint256 lastRefreshTimestamp;
        uint256 tokensEarnedBeforeLastRefresh;
        // A multiplier defaults to 1 but can be set by a manager in the future for a particular address. This increases
        // the overall rate of earning.
        StakingMultiplier stakingMultiplier;
    }
    mapping(address => AccountInfo) public accounts;

    struct TokenInfo {
        bool isLocked;
        uint256 lockedUntil;
        address owner;
    }
    mapping(uint256 => TokenInfo) public tokens;

    // Addresses that are allowed to do things like deduct tokens from a user's account or award earning multipliers.
    mapping(address => bool) public approvedManagers;

    IStakingListener[] listeners;

    // Earning period for a surrealestate. Default to one hoour.
    uint256 public earnPeriodSeconds = 3600;

    modifier onlyApprovedManager() {
        require(
            owner() == msg.sender || approvedManagers[msg.sender],
            "Caller is not an approved manager"
        );
        _;
    }

    function _notifyAllListeners(address account) internal {
        for (uint256 i = 0; i < listeners.length; i++) {
            listeners[i].notifyChange(account);
        }
    }

    /** User must setApprovalForAll on the contract before staking. */
    function stake(uint256[] calldata tokenIds, bool lock) public {
        refreshTokensEarned(msg.sender);
        for (uint256 i = 0; i < tokenIds.length; i++) {
            require(
                surrealestates.ownerOf(tokenIds[i]) == msg.sender,
                "Not your token"
            );

            surrealestates.transferFrom(msg.sender, address(this), tokenIds[i]);
            tokens[tokenIds[i]].owner = msg.sender;
            accounts[msg.sender].pointsStaked += pointsByTokenId(tokenIds[i]);
        }
        accounts[msg.sender].numStaked += tokenIds.length;

        if (lock) {
            uint256 lockUntil = block.timestamp + stakingLockPeriod;
            for (uint256 i = 0; i < tokenIds.length; i++) {
                tokens[tokenIds[i]].lockedUntil = lockUntil;
                tokens[tokenIds[i]].isLocked = true;
                accounts[msg.sender].pointsStaked += pointsByTokenId(
                    tokenIds[i]
                );
            }
        }

        _notifyAllListeners(msg.sender);
    }

    /**
     * User can lock their staking in for the stakingLockPeriod, which increases their multiplier.
     */
    function lockStaking(uint256[] calldata tokenIds) public {
        refreshTokensEarned(msg.sender);
        uint256 lockUntil = block.timestamp + stakingLockPeriod;
        for (uint256 i = 0; i < tokenIds.length; i++) {
            require(
                tokens[tokenIds[i]].owner == msg.sender,
                "Token is not currently staked"
            );
            require(
                tokens[tokenIds[i]].lockedUntil < block.timestamp,
                "Token is already locked"
            );
            if (!tokens[tokenIds[i]].isLocked) {
                tokens[tokenIds[i]].isLocked = true;
                accounts[msg.sender].pointsStaked += pointsByTokenId(
                    tokenIds[i]
                );
            }
            tokens[tokenIds[i]].lockedUntil = lockUntil;
        }
        _notifyAllListeners(msg.sender);
    }

    function refreshTokensEarned(address addr) internal {
        if (block.timestamp == accounts[addr].lastRefreshTimestamp) {
            // No need to refresh anything if we're up to date.
            return;
        }
        if (accounts[addr].lastRefreshTimestamp == 0) {
            // If this is the first refresh ever done, then just set the timestamp and return.
            accounts[addr].lastRefreshTimestamp = block.timestamp;
            return;
        }

        uint256 totalTokensEarnedSinceLastRefresh = calculateTokensEarnedSinceLastRefresh(
                addr
            );
        accounts[addr]
            .tokensEarnedBeforeLastRefresh += totalTokensEarnedSinceLastRefresh;
        accounts[addr].lastRefreshTimestamp = block.timestamp;
    }

    function calculateTokensEarnedSinceLastRefresh(address addr)
        public
        view
        returns (uint256)
    {
        uint256 secondsStakedSinceLastRefresh = block.timestamp -
            accounts[addr].lastRefreshTimestamp;

        return
            (secondsStakedSinceLastRefresh *
                (accounts[addr].pointsStaked) *
                (accounts[addr].stakingMultiplier.numeratorMinus1 + 1)) /
            (accounts[addr].stakingMultiplier.denominatorMinus1 + 1) /
            earnPeriodSeconds;
    }

    /**
     * To unstake, the user calls this function with the tokenIds they want to unstake.
     */
    function unstake(uint256[] calldata tokenIds) public {
        refreshTokensEarned(msg.sender);

        for (uint256 i = 0; i < tokenIds.length; i++) {
            require(
                tokens[tokenIds[i]].owner == msg.sender,
                "Caller is not currently staking the provided tokenId"
            );
            _unstakeSingle(tokenIds[i]);
        }
        accounts[msg.sender].numStaked -= tokenIds.length;
        _notifyAllListeners(msg.sender);
    }

    // Caller is responsible for deducted accounts[addr].numStaked 
    function _unstakeSingle(uint256 tokenId) internal {
        require(
            tokens[tokenId].lockedUntil < block.timestamp,
            "Token is still locked"
        );
        accounts[tokens[tokenId].owner].pointsStaked -= pointsByTokenId(
            tokenId
        );

        // If we are past the token locktime, then we need to update the the lockedTokens map as well.
        if (tokens[tokenId].isLocked) {
            tokens[tokenId].isLocked = false;
            // Deduct again because it was locked, so it was earning double.
            accounts[tokens[tokenId].owner].pointsStaked -= pointsByTokenId(
                tokenId
            );
        }

        surrealestates.transferFrom(address(this), msg.sender, tokenId);

        tokens[tokenId].owner = address(0);
    }

    function addApprovedManager(address managerAddr) public onlyOwner {
        approvedManagers[managerAddr] = true;
    }

    function removeApprovedManager(address managerAddr) public onlyOwner {
        approvedManagers[managerAddr] = false;
    }

    function setStakingLockPeriod(uint256 newPeriod)
        public
        onlyApprovedManager
    {
        stakingLockPeriod = newPeriod;
    }

    function setEarnPeriod(uint256 newSeconds) public onlyApprovedManager {
        earnPeriodSeconds = newSeconds;
    }

    function setEarningMultiplier(
        address addr,
        uint256 numerator,
        uint256 denominator
    ) public onlyApprovedManager {
        refreshTokensEarned(addr);
        accounts[addr].stakingMultiplier = StakingMultiplier(
            numerator - 1,
            denominator - 1
        );
    }

    function addStakingListener(address contractAddress) public onlyOwner {
        listeners.push(IStakingListener(contractAddress));
    }

    function resetStakingListeners() public onlyOwner {
        delete listeners;
    }

    // Do not use in actual transaction due to massive gas cost.
    function stakedTokensOfOwner(
        address addr,
        uint256 start,
        uint256 stop
    ) public view returns (uint256[] memory) {
        if (accounts[addr].numStaked == 0) {
            return new uint256[](0);
        }

        uint256 index = 0;
        uint256[] memory ownedTokens = new uint256[](accounts[addr].numStaked);

        for (uint256 tokenId = start; tokenId <= stop; tokenId++) {
            if (tokens[tokenId].owner == addr) {
                ownedTokens[index] = tokenId;
                index++;
                if (index == accounts[addr].numStaked) {
                    break;
                }
            }
        }

        return ownedTokens;
    }

    // Only for use in emergency. Can be called by owner to unstake. Does not update the rest of the contract state.
    function unstakeAsOwner(address addr, uint256[] calldata tokenIds)
        public
        onlyOwner
    {
        for (uint256 i = 0; i < tokenIds.length; i++) {
            surrealestates.transferFrom(address(this), addr, tokenIds[i]);
        }
    }

    function pointsByTokenId(uint256 tokenId) public pure returns (uint256) {
        return 100 + uint256(uint8(rawPointsByTokenId[tokenId]));
    }

    bytes constant rawPointsByTokenId =
        hex"0203020202020208040505030405050202050302020808080502040504050208020704020208040205020202020402030805020202040202020304020702020502070207020205020502020502050304020502020702020202020203040202020802040502020f02040202080202020702020208050505040503020502050503050205020403020502020202020403040302040202020202020202020208020202050404080808040202020205050207020f05040202050302020402020203020502020505020202020404020402050705020402040205020f02080402020205020f040403020205050202020208050202020204020804020405080204020507050f0502050402020205020208040305040302020803020202020f05020202040504050204080504020205026407020508070204050805020202020f05050402070804030204020204020505020205020204030502050203020305020502020502020202020202020808050202020502020203070502050207020502020202050502050203080205040504050502020207020405040204020f020202020207030203040702020302050507030402050505020802020202020707022102050505020503020505020508020505020502070504050202050505020505020502040502020402030305020203030204020405040204020404030505020504020502022108020f0505020202020203020202020207050702050505020304020202020207050202020807080403070f0802050207040205020305020202070202050202020704020303020207030305050202030f02070803080502030802040802040508020202080f0205040505020202050502050402050405020203040205020507040205050305040402020402080202040507050f0304030204040505020403050408020f0202020f0203080202020508080f02020203050502050502040f0205020302020204080304020f020503050204020202020f0505030508020207070202020405020205050302020502020202050205020202020204080202040202050202040f0203040505020202020403070202050502070202050402020304020202210207020205040f050504020202050403020203020202020403020202070305020202020503020205050502080504020202020502020502050802050402050205020402050202050308020805050503040505040302040204030202020202050304050402030703040204050f020202050204050502050505020502020504020503050502020505020f020205020f040508050302022d0202020402050205020204050202020204020704080803020402050203030502040205030803020802052d020f05020221080205020303050205020204030502020202020202020303020202020704020402020404070205050307050202020502050802020202030402020208020f020805080402040805050205020502080502040704030302030302040705040202070f03020202020405030302070504020f0407020805020203050f08040502020408040502020405050202070302080f040202040403050205020502040202020202020505030205040203020204020702050802080502020303020402040205020f0502080f020202040205030202020408050502080302020505040405020203020202020503020203050202020302050804080202020203020205020505050203050502050208020203070404030505020202040202040505020205020502020705052105030802020202050202020702020205020205030202020202030205640508050305020502020802030503050507020202020504020402020202020202020502020202050202022d0203040f0804020502020503020204050502040204050405020202050302050f0802020502020208030204070f0f020207080202070505080202050203080208050205070202040f050205040204020404020202050205020202040802030405050802020202020205030205020504050704050202020202020205030202080502020407030f03020203050305040205050f0502030202020403020405050202050202050703020202030402030202020205050202020f0802050502070702080205040204050202050402020202040202070208040205030208050504050505020704020202020302020802050502080503050504030f040505040505020804040303020405020202020502020f020302020404020804020302080202020203050505052d07020305020205020205050202020202070502040402050202050302040207050503020207020402030302050203050502050408020f05020502020502050202020f02040f030f02020202020202050202020202020802020502040207210803070405040202020302020203080402020302020502030205030202052d05030505050202040205640502020f0802040204050404080203020503020205020505020503050207040402020205020f04020202020302040508020203020505030503020504050504020203030505080402020202040f0402020f020202020405020508050f020204020202020202070802020804040504040705030205020702020f0304020207050204020f02030802020808040402050504020f0204020202030205040204050405040202040204020203020f0202020202080208022d070207020205020503020205050202020404020f02080804020205040202070302050504050403020502030504030402080504040302040402020f020202020502020202020502020202020202020502040308020205020202020303040502020802080502040402040202020208050204020503050208050802020405040204030208020205040207050405020f07020204020208020505020305050204070704050205020204050502050302040205050808050404050302020307050204030202070402050f050205050507030505020208040202040405022d040504020502020202030208030303020208030504020207020802040502020202020304020203020402020504050405020202050f050705050202030502040402070203050208020207020202020207070202020205020202050303020208020802050702020504050405020205050202040f02020208020502080504020402040f08050f0202050503020205020502020207020402050805020203020202020504050f0404050403030303070204040508020202020804050503020202040f020202020502020408040502020203020202020205020802020402020504020204050802020205080205020202050502020202020202020502050505020802050205080203020202050402030202020503020202020202020502040f0205020502040304040505020204020205022d05050405020202020404020502040505020305020307050502020202080704020402020502050502020202020202050702050202020504020203020708050502040507020705040205020302040802020202020502020302050502050207020202080502050302050205020202070202050202040503020703020208050802050205030202040205080205020402020505050205040405050204020702050f02020304050f020702020202080302020702020202030f04040202080205080702020404030202040502020202040805022105020207020307080202080305040802040302080205020305020305020305020203020503020202050205020402070302020202050307020505050203020505050402020205030f0205040208080202040208080202020203030808020205020502020503050705020202040205030205050202020404020805020302040502020402020502040508020305070205050208020508040202020803020502020204030502040405080203020302050702020502020404020204020702050504020205050202020402040703050502040402030203020202020f0221020202050405030307020202040402030202020504020405030202020802080504020502020302020402050705030f02050205050f05020202020502020205030205050802040204030208020205030205020f05030205080405070202030505050205020203020404020202020408070208020405030402050405030502080502020202050502020402020408050407030505050202020202020207020f08020402020205020802020405020805020f0404020702050202070305020507040502040707050304040502050702020f0204030208030202050f04080202020202020505020402020302020202020205030505020502070202020502020203040203080204040502020302020202050502030f020502050208040502080402020207050202040405050502020202020202030f02040204080302030305020202050202020f0202020305050405020502020202020205020f050404080405050202020508030202020405030202020202050502020402020202040708050203030802020502020204020502040205050402020205050504030502050205050308020f0205080202020203020302080202020505020505050321030502020802040305080302030705020404020308040502020202020402050305080208020f05020202020502020505020402050205020508050502040205050202050205020702020205020502070403050508080202020204020204020f030202050702040302080202070402020405020202020203020802020204020505210702020205020503040f050802020805050505050f04020805080202030208050402040802050304020502050502080307040208040302020803050f0202020502040f020303030405040202050202020202020205020202020503020502030507050f02020202080f0f020202030202080202040204020402040508040208030502040205020202050202040807020503020202020504030405020502020207020307020304070302020202020302020205020205020302020404020202032105020204050202020502050402020204020202050402050305050205050405040202020204080205050205020505020305020f02040203020803020205020204050203020302040205050202050f0702020203020504080204020f03050807040507020502080402020205050205050203050808080205040302070205020202020202020202070202040402020404050f0802080302050208050405030808040505080402020202020202030505030203020202050508020502050504020402050f040302040802040202020402040402020205050505070805020f04020502040705030402020202020205050505040f020402020f030202050202050203040502020205640405050504020507050502030f02020405040408080203080403020f0508050205070702040202050505050205050408020302020205040202050408030507020502022d0502040204020202020f0502030205050505020505050205040202020202020204050505020505020202070302020408040202040202020205040505020508080305020205050502050202040504020205020203030202030505050202080405050202050404050402020405050202020302020f02020503050f02020202050f02050205020202080405020502050f050305050205020202020705050203020505020f030502020802020204020504020204020405050202040502020202020f05050205050203020805020504030505030205050302020402030208020405080204020205050402050203030202020202020803040405050405040502020202050508050302020502020203020705020502020502020505020502020202020305020502050504020205022d0202040202040808020207030508020402050205020303020703050302050504020202030502040505080202070203030f020402020202020208050402020504020507030208020703020204020204032105050702050204050202050405030f05020205020202020802040202050204020504020205030505040505040202020504020502080203030202020502020304020205040204020f04080202020702020508020207030502050f08020502020805020f020202020503040205080404080504070205020503020502050305020505050202080205020505020202030502020704050205020802080502050205020402020208020202020202080205080202020202050302050202040502080202040302030205020f02050202050502020502080205020702020202030502020505050f020402050703040205080202030202020702022d05080502040402040508080202050202052d04050205050505080505050302032d0508050405040305040802030705040702050202040502072d020802030505040202020805080205040502050202020202020202040302050f02050504020804020202020502020203080204020204040504020205050404070707050f020205020202020707020303040205020208050204050205020408080202020202020402020204050f0404020f02050402050305020204050502070407050403050504020202020205020204020202050403020f050302050f0307020302040202050302020202020204210505020205080204020204040203020504020502020208020305020f0204020403030204020203040203020402020404030202640202030202030208020205050208030704050202020402020805020f0502030502080302050202030203050302020202050502050204020407030203020502020205040505050702020204050202020508020502080202050204050203020205050502050202020802020202020502050205020802020505210802050202020505020202052d0503020205020202020f0203050502210302050203050503030202020203020407070f0805070505020202020202050505020408030208050204080504050207040502040503030205020204020202050402020404040502050807050502020305020502030302020508020705020204030f08020505050204020202070202050204040508020205050504050202020504080202020202020208020202050407020202020f020308020205020205050404020202030205070704040405030502020502020202022d0402020505020202050f0505020503020202022102020404020402020502020402020f0807050202020204020402020205050503020705050f020302050502050205040205050202020205020502050502020402050202030207080205020402040405020204020402020508040207050202050502050204050502050202050407020405040202050304050205030703040502020502020f020405050405020f04040205050208050304020202070208050203050802020803020f0202040202050202040205080703050802020402050204020404020402050205020202080803050204030505020504020202050202040205020202070402020508050304030304020802050202080205050f02020202050302020402050502050508050202020f07040202020702020205050403040204020503020203040802050502070205050302030505040202040202040202030202050302020504050202020202070207050505040307020208040305020f0202020402070507020504050202020807020202050805050203050205020302020302020205070305020205030205020405040505050203020205020202030802020208020202020205040503040208070405020204080505070308020207020505040204020202040202020207020405020202080f020502050521020204040f0502020202050502020502020205070703040405050502020207020205030504020502050502020408050f050202020205080205080802030704050208030508040202020202020803050402020805020204050505020704050705050402020502020f0202020202050202080505070702040205050505050202050505020f070205040208050408050203030305040502020204050505050202050205040202040305050402040402070202080502020204020304050202020202020402020405040802040f0704020205050502020403030202020502040402050404050502020804020202020204020802020407210202030502020705020204020202020805020802020502050202020202040502020205050202030f030705030202020207040202030505040405020303022102030203030702020f0205020202080403020205020502020204020205020502040502030502020202020502040202020508020505050505020203080202050404020504050203020502050f020502020205080504050202040205040502020208020505070202020202040402040305020502020404040205050503030402020264020205020202020202020202026404030404020202020708020803050f0503020505080205050502020207080202020302020504020802020207040305030502022d0204020204020f050402040802020407020204020f030205050202080502080703050202050202020205030203040502020503020202050202030202040504030205040205020502020502020802050402020402050f02020202080205050402040504050205050302020205020405040302030f070303080202020f04050203020302030502020502020f0508040405020802050203050402020202020f02020507020202050202050203050205020204050202020802050208020203050f03020205040402020803020205080204050204050505020202020204020505070508020405020505040202040207020205030205040502040702020208020402070208020f05050505080205070505050505020205040203020804020202050205040202020202020404050f0205020205030704020503020505050808050202050502020302030502040702020202020508050f0502050203020702050202050407020504080205020302030504020502020502020504080205020207040508050303040205050205020502020502020202070304050502050302020402040202050207020504020304040405020202050508080202020f050503020202040502020204040205040f020207020204020502030302020202030203020207020205020805020202020804020502040f0203080505020808020202030204050205030502080208020304020402040404050305050502070308050205050202050202020505020202020202080f0203020f020502050205020204020203040204050305020805050202020f08020205020203020207050208050202040202020402020f05210802020202050503020802040405050202050805020402030505070702030221040402020504030503020503050504020202020507080204020702050702020203020204020202020205050502050202020802020502020f08050402050503020202050204030505070205020405040205070503020203020407020705030205020205050402040702020802040402020202050508040502020202050502050202020202030f0402070f08050202020804050208050205020202040205020202030503040402020205080402050204050203020502020202070205020205020202020202020202020f0304080802050202050f03050502050264050502020302050504020205020f0402050502080503020208020505050502020f020204020304030804050405020205080502050304070f02030805040202070203020503050502040302020505050505030502050f0405020704020205020404020202020302020805020f040204020205030402080405050502020202040408050f020408020205020205020205020708050204040202020205050f0502020407050202050707020502020502020202050302030705020702020302030205020804020508080505080207020402020208030504050305080804040307020205050202030f020202020221020202020408020502020503040f020202040202020405050202020f020502050205040205050303020207050404020705040502050204030402070507020402020302030304050202080208050502040502020202040502080202020502020507040505020408050205020205020205030502040202040302020205020404040402020203040702020505640202020504020802030505050702050307020204020204020508050404040205050305080404020502070202020302050205080203020202050202080202020805020305020202050205020502020505020503050802080202020405050503020202030202020705040503070205020402020205050f04050204050f08050202050f04030202020505020202020304080503040202070504020208050208040202040802050207020f020205080203050502040808070502080302020202050202050502080f02050704050204050f02050402020805050708050f02020503080502020302030205040202020205020f0f0705020502050202020802050404080f050204030502020204020f05050202080305040402030505020f03020507030207020202030803050302050805020305040205020302050202050205040204020502080302050202030504050207030507040207020202080502050202050205020205020504020402020202042105020503050205050202050805020802020202040202020302020704020208020205022d020505070202020303040502040702210402030502020804020402020202020502020504020802020702040703030202040302080203050202030508050702040205040202050705050404020205050202020402070305070205050804050502040402040407050202210404070504020703050205050502020f04020305020207050502020505030202020f050202020f050202050305080f04050504020205080202020302080f0205080302050308070f050202050f050307080208020205020205020408020502050205050202050202020502050202050405020202050202020205050503050407020202070f0502020202080204020202020205052d02040202020f080202040202050202020502050202020202020204020202050502020202040504040204030802020402020207020402040204020208020502050202020202040205020202020f020208020208020307040203020502040205040504020804020804020702050202030805050402020502022102020305040204020202080202050802030202020f05070204040205050205040403030402030202050502020f0202020502050704080f0402050202050202040205050202050504020502020205020703050202050502050508020202020807020f0305070207080402070402020202020202020402050205080f08020505020205020308030505040505040502030304020202050802020202020204020404050308050505050305020202050204030302020202080208020202030f05020207020203020505050805020f0504080221020204050503020502020208020202040502020402020302020405020402050807020502050204020202040502020402020202020504040f05020804030802020205050302020205030208040205020208020202020205040521020202080202020205020507050f0708050203050202020205020202020202050202050802020302030f0202020204050805040802020203020502050f02050502050202020403040508050202040502050202080508050202050803040505020505020202080502030202210f03020205020204020205020208040404040202020204050204020703040205020502020502050502070205020202070308050804020702020505080205050303050202080202050304050202050502020204020202080502050205030202050405020804080702050402020205050508020205020f02050202020204030702020202050403020208050202020202020205050705020802050203030203040502020802050202020503050503020503020f0804020205040204050202050205050502050804020205030205050205020708020802030404020702020702020202050202050202070205040202020705020504050305020204030203020202040207050202020f05020402040402020505020202020802020205020305040508080202040205022d0f02020202040802020205020504020202040202020204020505020502020302030202020404050202020702040702020f0408040203050405020302030302040305020202030805020204050502020203050504030405050207020208040502050405050805020764020302020502020f05050504040205050805030302040204020502030202050208020202040307030402020204080421020305020302020703030205020202020502040405020202020707050f0502040405070205040502050502020805030805040805020205020305020504050205020202050202020502020503050202030202020f0208020502020202030f07050503040203020205070202050404020502050202020f080202020803080205080202020304040702040504020202020203020f020502070402020202030502050505030508040f020402020202040202040402050402070203030208020208040208070202040205050202020202020505070508070405020202020702020202050f05020304070202050202050202050202020203040402020207020505050402030203050505020f05020205070703070f040802040302080202040202070405020207030702050402050504020208040405020205030305080802020402080202050502050202020802020304040405040405030405020505050204020202040405030402040403070405020702040404030505020302030205050503020502020502020202070202020205020207080202020402050802020202020204040204020204040503020205020202050202080302020208040205020202050205020402020208020205020203030302080205040f04020205050203050203050203020405020803020205050203030202030f05050f0205050204050802030205020202020502040505020202020f0202030202040402020203020204020202070202020202020502020203040202040707050202020405080202040405040202020203020202030202020204020208050502040805030205020202040702020202020f02020405040204020505040805020404020807080402050205040802020502040503020204020407020402020203020704020204020202020202070208020202050305030204020202020205020303020202040204050502020804030304040208050502080205020407050404030502050505020f0f0502020f0f0405020202020502070f020205020205050502020202020403050205050202080205020207050408020207020207030708020202020205030307020803020708020205020202050205050505050202020805040202050202070f020802050502040503070708020802020802070305040204070502050202080204020504020202020204050704";
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (utils/Context.sol)

pragma solidity ^0.8.0;

/**
 * @dev Provides information about the current execution context, including the
 * sender of the transaction and its data. While these are generally available
 * via msg.sender and msg.data, they should not be accessed in such a direct
 * manner, since when dealing with meta-transactions the account sending and
 * paying for execution may not be the actual sender (as far as an application
 * is concerned).
 *
 * This contract is only required for intermediate, library-like contracts.
 */
abstract contract Context {
    function _msgSender() internal view virtual returns (address) {
        return msg.sender;
    }

    function _msgData() internal view virtual returns (bytes calldata) {
        return msg.data;
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (token/ERC721/utils/ERC721Holder.sol)

pragma solidity ^0.8.0;

import "../IERC721Receiver.sol";

/**
 * @dev Implementation of the {IERC721Receiver} interface.
 *
 * Accepts all token transfers.
 * Make sure the contract is able to use its token with {IERC721-safeTransferFrom}, {IERC721-approve} or {IERC721-setApprovalForAll}.
 */
contract ERC721Holder is IERC721Receiver {
    /**
     * @dev See {IERC721Receiver-onERC721Received}.
     *
     * Always returns `IERC721Receiver.onERC721Received.selector`.
     */
    function onERC721Received(
        address,
        address,
        uint256,
        bytes memory
    ) public virtual override returns (bytes4) {
        return this.onERC721Received.selector;
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (token/ERC721/IERC721Receiver.sol)

pragma solidity ^0.8.0;

/**
 * @title ERC721 token receiver interface
 * @dev Interface for any contract that wants to support safeTransfers
 * from ERC721 asset contracts.
 */
interface IERC721Receiver {
    /**
     * @dev Whenever an {IERC721} `tokenId` token is transferred to this contract via {IERC721-safeTransferFrom}
     * by `operator` from `from`, this function is called.
     *
     * It must return its Solidity selector to confirm the token transfer.
     * If any other value is returned or the interface is not implemented by the recipient, the transfer will be reverted.
     *
     * The selector can be obtained in Solidity with `IERC721.onERC721Received.selector`.
     */
    function onERC721Received(
        address operator,
        address from,
        uint256 tokenId,
        bytes calldata data
    ) external returns (bytes4);
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (access/Ownable.sol)

pragma solidity ^0.8.0;

import "../utils/Context.sol";

/**
 * @dev Contract module which provides a basic access control mechanism, where
 * there is an account (an owner) that can be granted exclusive access to
 * specific functions.
 *
 * By default, the owner account will be the one that deploys the contract. This
 * can later be changed with {transferOwnership}.
 *
 * This module is used through inheritance. It will make available the modifier
 * `onlyOwner`, which can be applied to your functions to restrict their use to
 * the owner.
 */
abstract contract Ownable is Context {
    address private _owner;

    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);

    /**
     * @dev Initializes the contract setting the deployer as the initial owner.
     */
    constructor() {
        _transferOwnership(_msgSender());
    }

    /**
     * @dev Returns the address of the current owner.
     */
    function owner() public view virtual returns (address) {
        return _owner;
    }

    /**
     * @dev Throws if called by any account other than the owner.
     */
    modifier onlyOwner() {
        require(owner() == _msgSender(), "Ownable: caller is not the owner");
        _;
    }

    /**
     * @dev Leaves the contract without owner. It will not be possible to call
     * `onlyOwner` functions anymore. Can only be called by the current owner.
     *
     * NOTE: Renouncing ownership will leave the contract without an owner,
     * thereby removing any functionality that is only available to the owner.
     */
    function renounceOwnership() public virtual onlyOwner {
        _transferOwnership(address(0));
    }

    /**
     * @dev Transfers ownership of the contract to a new account (`newOwner`).
     * Can only be called by the current owner.
     */
    function transferOwnership(address newOwner) public virtual onlyOwner {
        require(newOwner != address(0), "Ownable: new owner is the zero address");
        _transferOwnership(newOwner);
    }

    /**
     * @dev Transfers ownership of the contract to a new account (`newOwner`).
     * Internal function without access restriction.
     */
    function _transferOwnership(address newOwner) internal virtual {
        address oldOwner = _owner;
        _owner = newOwner;
        emit OwnershipTransferred(oldOwner, newOwner);
    }
}