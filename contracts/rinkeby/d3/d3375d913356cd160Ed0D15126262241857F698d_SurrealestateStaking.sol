// SPDX-License-Identifier: MIT
pragma solidity >=0.8.12 <0.9.0;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/ERC721/utils/ERC721Holder.sol";

// The NFT that can be staked here.
interface IPPASurrealestates {
    function transferFrom(
        address from,
        address to,
        uint256 tokenId
    ) external;

    function ownerOf(uint256 tokenId) external view returns (address);
}

// A listening contract can implement this function to get notified any time a user stakes or unstakes.
interface IStakingListener {
    function notifyChange(address account) external;
}

contract SurrealestateStaking is ERC721Holder, Ownable {
    IPPASurrealestates surrealestates;
    address surrealestateContractAddress;

    constructor() public {
        surrealestateContractAddress = _getSurrealestatesContractAddress();
        surrealestates = IPPASurrealestates(surrealestateContractAddress);
    }

    function _getSurrealestatesContractAddress()
        internal
        view
        returns (address)
    {
        address addr;
        assembly {
            switch chainid()
            case 1 {
                // mainnet
                addr := 0x6f3185b51a42e03a4f0eaaf37604ddd499ef9b12
            }
            case 4 {
                // rinkeby
                addr := 0x6551111b5d3C7e4B5436409C2e70A8Fbe1757407
            }
        }
        return addr;
    }

    // The period which people can lock their funds up for to get an extra multiplier on rewards earned.
    uint256 stakingLockPeriod = 7776000; // 90 days in seconds.

    struct StakingMultiplier {
        uint256 numeratorMinus1; // Store as "minus 1" because we want this to default to 1, but uninitialized vars default to 0.
        uint256 denominatorMinus1;
    }

    struct AccountInfo {
        uint256 numStaked;
        uint256 pointsStaked;
        uint256 lastRefreshTimestamp;
        uint256 tokensEarnedBeforeLastRefresh;
        // A multiplier defaults to 1 but can be set by a manager in the future for a particular address. This increases
        // the overall rate of earning.
        StakingMultiplier stakingMultiplier;
    }
    mapping(address => AccountInfo) public accounts;

    struct TokenInfo {
        bool isLocked;
        uint256 lockedUntil;
        address owner;
    }
    mapping(uint256 => TokenInfo) public tokens;

    // Addresses that are allowed to do things like deduct tokens from a user's account or award earning multipliers.
    mapping(address => bool) public approvedManagers;

    IStakingListener[] listeners;

    // Earning period for a surrealestate. Default to 10 hours.
    uint256 public earnPeriodSeconds = 36000;

    modifier onlyApprovedManager() {
        require(
            owner() == msg.sender || approvedManagers[msg.sender],
            "Caller is not an approved manager"
        );
        _;
    }

    function _notifyAllListeners(address account) internal {
        for (uint256 i = 0; i < listeners.length; i++) {
            listeners[i].notifyChange(account);
        }
    }

    /** User must setApprovalForAll on the contract before staking. */
    function stake(uint256[] calldata tokenIds, bool lock) public {
        refreshTokensEarned(msg.sender);
        for (uint256 i = 0; i < tokenIds.length; i++) {
            require(
                surrealestates.ownerOf(tokenIds[i]) == msg.sender,
                "Not your token"
            );

            surrealestates.transferFrom(msg.sender, address(this), tokenIds[i]);
            tokens[tokenIds[i]].owner = msg.sender;
            accounts[msg.sender].pointsStaked += pointsByTokenId(tokenIds[i]);
        }
        accounts[msg.sender].numStaked += tokenIds.length;

        if (lock) {
            uint256 lockUntil = block.timestamp + stakingLockPeriod;
            for (uint256 i = 0; i < tokenIds.length; i++) {
                tokens[tokenIds[i]].lockedUntil = lockUntil;
                tokens[tokenIds[i]].isLocked = true;
                accounts[msg.sender].pointsStaked += pointsByTokenId(
                    tokenIds[i]
                );
            }
        }

        _notifyAllListeners(msg.sender);
    }

    /**
     * User can lock their staking in for the stakingLockPeriod, which increases their multiplier.
     */
    function lockStaking(uint256[] calldata tokenIds) public {
        refreshTokensEarned(msg.sender);
        uint256 lockUntil = block.timestamp + stakingLockPeriod;
        for (uint256 i = 0; i < tokenIds.length; i++) {
            require(
                tokens[tokenIds[i]].owner == msg.sender,
                "Token is not currently staked"
            );
            require(
                tokens[tokenIds[i]].lockedUntil < block.timestamp,
                "Token is already locked"
            );
            if (!tokens[tokenIds[i]].isLocked) {
                tokens[tokenIds[i]].isLocked = true;
                accounts[msg.sender].pointsStaked += pointsByTokenId(
                    tokenIds[i]
                );
            }
            tokens[tokenIds[i]].lockedUntil = lockUntil;
        }
        _notifyAllListeners(msg.sender);
    }

    function refreshTokensEarned(address addr) internal {
        if (block.timestamp == accounts[addr].lastRefreshTimestamp) {
            // No need to refresh anything if we're up to date.
            return;
        }
        if (accounts[addr].lastRefreshTimestamp == 0) {
            // If this is the first refresh ever done, then just set the timestamp and return.
            accounts[addr].lastRefreshTimestamp = block.timestamp;
            return;
        }

        uint256 totalTokensEarned = calculateTokensEarned(addr);
        accounts[addr].tokensEarnedBeforeLastRefresh = totalTokensEarned;
        accounts[addr].lastRefreshTimestamp = block.timestamp;
    }

    function calculateTokensEarned(address addr) public view returns (uint256) {
        uint256 secondsStakedSinceLastRefresh = block.timestamp -
            accounts[addr].lastRefreshTimestamp;

        uint256 tokensEarnedSinceLastRefresh = (secondsStakedSinceLastRefresh *
            (accounts[addr].pointsStaked) *
            (accounts[addr].stakingMultiplier.numeratorMinus1 + 1)) /
            (accounts[addr].stakingMultiplier.denominatorMinus1 + 1) /
            earnPeriodSeconds;
        return
            accounts[addr].tokensEarnedBeforeLastRefresh +
            tokensEarnedSinceLastRefresh;
    }

    /**
     * To unstake, the user calls this function with the tokenIds they want to unstake.
     */
    function unstake(uint256[] calldata tokenIds) public {
        refreshTokensEarned(msg.sender);

        for (uint256 i = 0; i < tokenIds.length; i++) {
            require(
                tokens[tokenIds[i]].owner == msg.sender,
                "Caller is not currently staking the provided tokenId"
            );
            _unstakeSingle(tokenIds[i]);
        }
        accounts[msg.sender].numStaked -= tokenIds.length;
        _notifyAllListeners(msg.sender);
    }

    // Caller is responsible for deducted accounts[addr].numStaked
    function _unstakeSingle(uint256 tokenId) internal {
        require(
            tokens[tokenId].lockedUntil < block.timestamp,
            "Token is still locked"
        );
        accounts[tokens[tokenId].owner].pointsStaked -= pointsByTokenId(
            tokenId
        );

        // If we are past the token locktime, then we need to update the the lockedTokens map as well.
        if (tokens[tokenId].isLocked) {
            tokens[tokenId].isLocked = false;
            // Deduct again because it was locked, so it was earning double.
            accounts[tokens[tokenId].owner].pointsStaked -= pointsByTokenId(
                tokenId
            );
        }

        surrealestates.transferFrom(address(this), msg.sender, tokenId);

        tokens[tokenId].owner = address(0);
    }

    function addApprovedManager(address managerAddr) public onlyOwner {
        approvedManagers[managerAddr] = true;
    }

    function removeApprovedManager(address managerAddr) public onlyOwner {
        approvedManagers[managerAddr] = false;
    }

    function setStakingLockPeriod(uint256 newPeriod)
        public
        onlyApprovedManager
    {
        stakingLockPeriod = newPeriod;
    }

    function setEarnPeriod(uint256 newSeconds) public onlyApprovedManager {
        earnPeriodSeconds = newSeconds;
    }

    function setEarningMultiplier(
        address addr,
        uint256 numerator,
        uint256 denominator
    ) public onlyApprovedManager {
        refreshTokensEarned(addr);
        accounts[addr].stakingMultiplier = StakingMultiplier(
            numerator - 1,
            denominator - 1
        );
    }

    function addStakingListener(address contractAddress) public onlyOwner {
        listeners.push(IStakingListener(contractAddress));
    }

    function resetStakingListeners() public onlyOwner {
        delete listeners;
    }

    // Do not use in actual transaction due to massive gas cost.
    function stakedTokensOfOwner(
        address addr,
        uint256 start,
        uint256 stop
    ) public view returns (uint256[] memory) {
        if (accounts[addr].numStaked == 0) {
            return new uint256[](0);
        }

        uint256 index = 0;
        uint256[] memory ownedTokens = new uint256[](accounts[addr].numStaked);

        for (uint256 tokenId = start; tokenId <= stop; tokenId++) {
            if (tokens[tokenId].owner == addr) {
                ownedTokens[index] = tokenId;
                index++;
                if (index == accounts[addr].numStaked) {
                    break;
                }
            }
        }

        return ownedTokens;
    }

    // Only for use in emergency. Can be called by owner to unstake. Does not update the rest of the contract state.
    function unstakeAsOwner(address addr, uint256[] calldata tokenIds)
        public
        onlyOwner
    {
        for (uint256 i = 0; i < tokenIds.length; i++) {
            surrealestates.transferFrom(address(this), addr, tokenIds[i]);
        }
    }

    function pointsByTokenId(uint256 tokenId) public pure returns (uint256) {
        return 1000 + uint256(uint8(rawPointsByTokenId[tokenId]));
    }

    bytes constant rawPointsByTokenId =
        hex"141e141414141450282d2d1e28322d1414321e14145050502d142832282d14501441281414502814321414141428141e5032141414281414141e28144114143214411441141432142d141432142d1e28142d1414411414141414141e281414145014282d14149614281414501414144114141450323232282d1e14321432321e32143214281e14321414141414281e281e142814141414141414141414501414142d282850505028141414142d321441149632281414321e1414281414141e14321414323214141414282814281432412d142814281432149614502814141432149628281e1414323214141414502d141414142814502814282d50142814324132963214322814141432141450281e32281e1414501e141414149632141414282d282d1428502d2814142d143e841142d5041142832503214141414962d2d28144150281e1428141428142d2d1414321414281e321432141e141e32143214143214141414141414145050321414142d1414141e412d14321441142d1414141432321432141e50142d2832282d321414144114283228142814961414141414411e141e284114141e14322d411e2814322d2d1450141414141441411414a14323232142d1e14323214325014323214321441322832141432322d142d32143214282d141428141e1e3214141e1e14281428322814281428281e32321432281432141414a501496323214141414141e141414141441324114323232141e2814141414144132141414504150281e41965014321441281432141e32141414411414321414144128141e1e1414411e1e323214141e961441501e5032141e50142850142832501414145096142d283232141414322d1432281432283214141e281432143241281432321e2d28281414281450141428324132961e281e142828323214281e322850149614141496141e501414142d5050961414141e323214322d1428961432141e14141428501e28149614321e32142814141414962d321e325014144141141414282d1414322d1e14142d141414142d142d1414141414285014142814142d14142896141e28322d14141414281e4114142d2d14411414322814141e2814141414a14411414322896322d2814141432281e14141e14141414281e141414411e3214141414321e1414322d2d14502d28141414143214142d143250143228142d142d142814321414321e5014503232321e283232281e142814281e1414141414321e282d28141e411e28142832961414143214282d2d1432322d142d14142d2814321e2d3214142d3214961414321496282d50321e14141c214141428142d142d1414282d141414142814412850501e14281432141e1e32142814321e501e1450142d1c2149632141414a50142d141e1e32142d1414281e3214141414141414141e1e14141414412814281414282841142d321e413214141432143250141414141e2814141450149614503250281428502d32142d1432145032142841281e1e141e1e1428412d28141441961e1414141428321e1e14412d281496284114503214141e2d9650282d141428502832141428322d1414411e14509628141428281e32142d143214281414141414142d321e143228141e141428144114325014502d14141e1e14281428143214962d1450961414142814321e1414142850323214501e1414323228283214141e14141414321e14141e2d1414141e1432502850141414141e141432142d3232141e32321432145014141e4128281e3232141414281414282d3214143214321414412d3214a321e501414141432141414411414143214142d1e14141414141e14323e82d502d1e321432141450141e2d1e323241141414142d28142814141414141414143214141414321414141c2141e28965028143214142d1e141428322d14281428322832141414321e1432965014142d141414501e142841969614144150141441323250141432141e50145032143241141428963214322814281428281414142d14321414142850141e28323250141414141414321e1432142d283241283214141414141414321e14145032141428411e961e14141e321e2d2814322d9632141e141414281e1428323214142d14142d411e1414141e28141e1414141432321414149650143232144141145014322814283214143228141414142814144114502814321e1450322d282d322d144128141414141e1414501432321450321e3232281e96283232283232145028281e1e142832141414142d141496141e14142828145028141e1450141414141e323232321c241141e3214143214142d3214141414144132142828142d1414321e1428144132321e1414411428141e1e1432141e322d142d285014963214321414321432141414961428961e9614141414141414321414141414145014142d1428144114a501e412832281414141e1414141e502814141e14142d141e14321e1414321c2321e322d3214142814323e832141496501428142832282850141e14321e14143214323214321e2d144128281414142d149628141414141e1428325014141e142d2d1e321e142d282d2d2814141e1e2d3250281414141428962814149614141414282d14325032961414281414141414144150141450282832282841321e143214411414961e281414413214281496141e5014145050282814323228149614281414141e14322814282d283228141428142814141e14961414141414501450141c241144114143214321e141432321414142828149614505028141432281414411e142d322832281e142d141e32281e2814503228281e142828141496141414142d14141414143214141414141414143214281e50141432141414141e1e282d14145014502d1428281428141414145032142814321e32145032501414282d2814281e14501414322814412d2832149641141428141450142d2d141e323214284141282d1432141428323214321e1428142d325050322828321e14141e412d14281e141441281432963214323232411e3232141450281414282832141c22832281432141414141e14501e1e1e1414501e3228141441145014283214141414141e2814141e1428141432282d282d1414142d963241323214141e2d1428281441141e321450141441141414141441411414141432141414321e1e1414501450143241141432282d282d14142d321414289614141450143214503228142814289650329614142d321e1414321432141414411428142d503214141e1414141432283296282832281e1e1e1e411428282d5014141414502832321e141414289614141414321414285028321414141e14141414143214501414281414322814142832501414143250142d141414322d141414141414141432142d322d1450142d143250141e1414143228141e141414321e1414141414141432142896142d142d14281e28283232141428141432141c22d322832141414142828142d14282d2d141e32141e412d32141414145041281428141432143232141414141414143241142d1414142d2814141e144150323214282d4114413228142d141e14285014141414143214141e142d2d14321441141414502d142d1e1432142d14141441141432141428321e14411e14145032501432142d1e141428143250142d142814142d2d2d142d282832321428144114329614141e283296144114141414501e141441141414141e96282814145014325041141428281e14142832141414142850321414a32141441141e41501414501e2d285014281e14501432141e32141e32141e3214141e142d1e141414321432142814411e14141414321e4114323232141e14322d2d281414142d1e96143228145050141428145050141414141e1e505014142d14321414321e3241321414142814321e1432321414142828145032141e14283214142814143214282d50141e3241143232145014325028141414501e1432141414281e321428283250141e141e142d411414321414282814142814411432322814143232141414281428411e2d32142828141e141e14141414961414a1414143228321e1e411414142828141e1414142d281428321e1414145014502d28143214141e141428142d41321e961432142d3296321414141432141414321e14322d50142814281e145014142d1e14321496321e142d5028324114141e2d322d142d14141e1428281414141428504114501428321e28142d282d1e2d145032141414143232141428141428502d28411e32322d141414141414144114965014281414142d14501414283214503214962828144114321414411e2d1432412832142841412d1e28282d14324114149614281e14501e14142d9628501414141414143232142814141e141414141414321e322d143214411414142d1414141e28141e501428283214141e14141414322d141e96142d142d14502832145028141414412d141428282d2d32141414141414141e9614281428501e141e1e321414142d141414961414141e2d32282d14321414141414142d149632282850282d2d1414142d501e141414282d1e14141414142d321414281414141428415032141e1e50141432141414281432142814322d281414142d322d281e2d142d1432321e501496143250141414141e141e1450141414322d142d32321e14a1e3214145014281e2d501e141e4132142828141e50283214141414142814321e3250145014962d141414142d141432321428143214321432503232142814323214142d142d144114141432142d1441281e32325050141414142814142814961e1414324114281e1450141441281414282d14141414141e145014141428142d3214a4114141432142d1e289632501414502d2d2d322d962814502d5014141e14502d2814285014321e28142d14323214501e41281450281e1414501e2d9614141432142896141e1e1e283228141432141414141414143214141414321e1432141e32412d96141414145096961414141e14145014142814281428142832502814501e32142814321414142d141428504114321e1414141432281e2832142d14141441141e41141e28411e14141414141e14141432141432141e141428281414141e14a321414283214141432143228141414281414143228142d1e323214322d282d281414141428501432321432143232141e2d14961428141e14501e1414321414282d141e141e142814323214143296411414141e14322850142814961e32504128324114321450281414142d32143232141e2d5050501432281e1441142d14141414141414141441141428281414282832965014501e143214503228321e505028322d5028141414141414141e2d321e141e141414323250142d142d32281428142d96281e14285014281414142814282814141432323232415032149628142d142841321e2814141414141432323232289614281414961e141432141432141e2832141414323e828322d2d28142d412d32141e961414283228285050141e50281e1496325032142d41411428141432322d32142d322850141e141414322814143228501e3241143214141c22d1428142814141414962d141e14322d2d2d1432322d14322814141414141414282d3232143232141414411e1414285028141428141414143228322d143250501e2d1414322d32142d1414282d2814143214141e1e14141e323232141450282d2d141432282832281414282d2d1414141e14149614142d1e3296141414143296142d143214141450282d142d1432962d1e2d32143214141414413232141e14323214961e32141450141414281432281414281428322d141428321414141414962d3214322d141e1450321432281e322d1e1432321e141428141e145014282d50142814142d3228142d141e1e141414141414501e28282d2d2832282d141414142d2d50321e1414321414141e144132142d14143214143232142d14141414141e2d1432142d3228141432141c214142814142850501414411e32501428142d1432141e1e14411e2d1e14322d281414141e321428322d50141441141e1e961428141414141414503228141432281432411e145014411e1414281414281e14a2d3241143214283214143228321e962d14142d1414141450142814143214281432281414321e3232282d32281414142d2814321450141e1e1414143214141e2814142d2814281496285014141441141432501414411e321432965014321414502d149614141414321e281432502828502d28411432142d1e143214321e3214322d3214145014321432321414141e2d1414412832142d145014502d1432142d142814141450141414141414501432501414141414321e14321414283214501414281e141e14321496142d14142d2d14142d145014321441141414141e2d141432322d9614281432411e28142d5014141e1414144114141c232503214282814282d505014142d1414321c2283214322d322d502d32321e141e1c22d502d282d281e322850141e412d284114321414283214411c21450141e2d3228141414503250142d2832142d1414141414141414281e1432961432322814502814141414321414141e501428141428283228141432322828414141329614142d141414144141141e1e28142d1414503214282d142d142850501414141414142814141428329628281496143228142d1e32141428322d1441284132281e3232281414141414321414281414142d281e1496321e142d961e41141e14281414321e1414141414142814a323214142d50142814142828141e142d28142d14141450141e321496142814281e1e142814141e28141e1428141428281e14143e814141e14141e14501414323214501e412832141414281414502d149632141e3214501e143214141e141e321e141414143232143214281428411e141e143214141432282d2d324114141428321414143250142d1450141432142832141e141432322d14321414145014141414143214321432145014142d2d14a50143214141432321414142d1c2321e1414321414141496141e2d321414a1e1432141e32321e1e141414141e1428414196502d412d321414141414143232321428501e14502d1428503228321441282d14282d1e1e1432141428141414322814142828283214325041323214141e321432141e1e141432501441321414281e965014322d3214281414144114142d1428283250141432322d283214141432285014141414141414501414143228411414141496141e5014143214142d3228281414141e142d41412828282d1e3214143214141414141c228141432321414142d96323214321e1414141414a14142828142814142d141428141496504132141414142814281414142d2d321e1441322d96141e1432321432143228143232141414142d142d142d32141428143214141e14415014321428142828321414281428141432502814412d141432321432142832321432141432284114282d281414321e282d142d1e411e283214143214149614283232282d14962828142d321450321e2814141441145032141e32501414501e1496141428141432141428142d50411e3250141428143214281428281428142d143214141450501e2d14281e2d32143228141414321414281432141414412814142d50321e281e1e281450142d1414501432329614141414321e14142814322d142d325032141414964128141414411414143232281e28142814321e14141e2850142d2d14411432321e141e32322814142814142814141e14142d1e14142d28321414141414411441323232281e41141450281e32149614141428144132411432283214141450411414142d502d32141e321432141e14141e1414142d411e3214142d1e142d14282d282d3232141e1414321414141e5014141450141414141432282d1e28145041282d141428502d2d411e501414411432322814281414142814141414411428321414145096143214322d14a141428289632141414142d321414321414143241411e28283232321414144114142d1e3228143214323214142850329632141414142d5014325050141e41282d14501e325028141414141414501e3228141450321414282d32321441282d41323228141432141496141414141432141450323241411428142d3232323214142d323214964114322814503228502d141e1e1e32283214141428322d2d2d1414321432281414281e2d2d2814282814411414503214141428141e283214141414141428141428322850142896412814142d32321414281e1e14141432142828143228282d321414502814141414142814501414284114a14141e321414413214142814141414502d145014143214321414141414282d141414323214141e961e412d1e14141414412814141e323228282d141e1e1414a141e141e1e41141496143214141450281e1414321432141414281414321432142832141e3214141414142d14281414142d5014322d2d323214141e5014143228281432282d141e1432142d96143214141432502d2832141428142d282d14141450142d2d411414141414282814281e321432141428282814322d2d1e1e281414143e814142d141414141414141414143e8281e282814141414415014501e32962d1e142d325014322d2d14141441501414141e14143228145014141441281e2d1e3214141c21428141428149632281428501414284114142814961e143232141450321450411e2d14142d14141414321e141e282d1414321e1414143214141e14142832281e143228142d14321414321414501432281414281432961414141450142d322814283228321432321e1414143214282d281e141e96411e1e50141414962832141e141e141e32141432141496325028283214501432141e322814141414149614142d411414143214142d141e32143214142832141414501432145014141e2d961e14142d28281414501e1414325014282d1428322d32141414141428142d2d41325014282d14322d2814142814411414321e143228321428411414145014281441145014963232323250143241323232322d14143228141e1450281414143214322814141414141428283296143214142d1e412814321e142d2d325050321414323214141e141e2d142841141414141432502d96321432141e1441143214142d2841143228501432141e141e322814321414321414322850142d141441283250321e1e28142d321432143214143214141414411e283232142d1e14142814281414321441142d28141e28282832141414322d5050141414962d321e1414142832141414282814322896141441141428142d141e1e141414141e141e14144114142d145032141414145028142d142896141e502d2d1450501414141e142832142d1e2d14501450141e281428142828282d1e2d323214411e5032142d3214143214141432321414141414145096141e149614321432142d14142814141e281428321e321450322d141414965014143214141e1414412d145032141428141414281414963214a501414141432321e14501428282d3214143250321428141e2d324141141e1414a2828141432281e321e142d1e2d322814141414324150142814411432411414141e1414281414141414322d2d143214141450141432141496502d28142d2d1e1414143214281e323241142d142832281432412d1e14141e1428411441321e14321414322d28142841141450142828141414142d3250282d141414143232143214141414141e9628144196502d141414502832145032143214141428142d1414141e321e2828141414325028142d14282d141e14321414141441142d14142d14141414141414141414961e285050142d14142d961e3232142d143e8323214141e1432322814143214962814322d1450321e14145014322d3232141496141428141e281e50282d2832141432503214321e284196141e502d28141441141e142d1e323214281e14142d323232321e32142d962832144128141432142828141414141e1414503214962814281414321e28145028322d2d14141414282850329614285014143214142d1414321441503214282814141414322d963214142841321414324141142d14142d14141414321e141e4132144114141e141e14321450281432505032325014411428141414501e2d28321e32505028281e411414323214141e96141414141414a141414142850143214142d1e289614141428141414282d321414149614321432143228142d321e1e1414412d2828144132282d143214281e2814413241142814141e141e1e282d14145014502d3214282d14141414283214501414143214142d4128322d14285032143214143214142d1e2d14281414281e1414143214282828281414141e284114142d323e814141432281450141e2d322d41142d1e4114142814142814325032282828142d321e32502828142d14411414141e1432143250141e1414142d1414501414145032141e32141414321432143214142d2d14321e325014501414142832322d1e1414141e141414412d28321e4114321428141414323296283214283296503214142d96281e1414143232141414141e2850321e281414412d281414502d1450281414285014321441149614142d50141e323214285050412d14501e14141414321414322d145096142d41283214282d96143228141450322d415032961414321e502d14141e141e142d28141414142d149696412d14321432141414501432282850963214281e32141414281496322d1414501e322828141e323214961e1432411e14411414141e501e2d1e142d5032141e3228142d141e143214142d1432281428143214501e143214141e32283214411e3241281441141414503214321414321432141432142d281428141414142814a3214321e3214323214142d5032145014141414281414141e14144128141450141432141c2143232411414141e1e28321428411414a28141e2d1414502814281414141414321414322814501414411428411e1e1414281e1450141e2d14141e32502d41142814322814142d413232282814142d321414142814411e2d41143232502832321428281428284132141414a2828412d2814411e32142d2d2d14149628141e321414412d32141432321e141414963214141496321414321e325096282d3228141432501414141e1450961432501e142d1e5041962d141432962d1e4150145014142d14142d142850142d142d14323214143214141432143214142d283214141432141414143232321e32284114141441963214141414501428141414141432321c2142814141496501414281414321414142d14321414141414141428141414322d141414142832282814281e5014142814141441142814281428141450142d143214141414142814321414141496141450141450141e4128141e142d14281432282d281450281450281441142d14141e50323228141432141414a14141e322814281414145014143250141e14141496324114282814322d143228281e1e28141e1414323214149614141432142d4128509628143214143214142814322d1414322d2814321414143214411e3214142d3214322d5014141414504114961e2d4114415028144128141414141414141428142d142d50965014322d14142d141e501e32322832322832141e1e28141414325014141414141428142828321e502d2d2d321e321414143214281e1e141414145014501414141e963214144114141e14323232503214962d28501414a1414282d321e143214141450141414283214142814141e141428321428143250411432143214281414142832141428141414141432282896321450281e50141414322d1e141414321e145028142d141450141414141432283214a1414145014141414321432412d96415032141e32141414142d141414141414321414325014141e141e96141414142832503228501414141e1432143296143232142d141414281e2832503214142832142d1414502d5032141432501e2832321432321414145032141e141414a961e14143214142814143214145028282828141414142832142814411e281432142d14142d14322d1441142d141414411e502d502814411414322d501432321e1e321414501414321e282d14142d321414142814141450321432142d1e14143228321450285041143228141414322d325014142d1496143214141414281e41141414142d281e14145032141414141414142d32413214501432141e1e141e28321414501432141414321e32321e14321e1496502814142d28142832141432142d32321432502814142d1e142d3214321441501450141e282814411414411414141432141432141441143228141414412d143228321e321414281e141e141414281441321414149632142814282814143232141414145014141432141e2d28325050141428142d141c2961414141428501414142d14322814141428141414142814322d143214141e141e14141428283214141441142841141496285028141e322832141e141e1e14281e321414141e503214142832321414141e3232281e282d321441141450282d1432283232503214413e8141e1414321414963232322828142d3250321e1e142814281432141e1414321450141414281e411e2814141428502814a141e32141e1414411e1e1432141414142d142828321414141441412d96321428283241143228321432321414502d1e5032285032141432141e32143228321432141414321414142d14142d1e3214141e1414149614501432141414141e964132321e28141e14142d411414322828142d14321414149650141414501e501432501414141e2828411428322814141414141e14961432144128141414141e2d142d32321e3250289614281414141428141428281432281441141e1e1450141450281450411414281432321414141414143232413250412832141414144114141414329632141e284114142d141432141432141414141e282814141441142d2d3228141e141e2d323214963214143241411e4196285014281e145014142814144128321414411e41142d28142d32281414502828321414321e1e2d505014142814501414323214321414145014141e2828283228282d1e28321432322d14281414142828321e281428281e4128321441142828281e322d141e141e14322d321e14321414321414141441141414142d14144150141414281432501414141414142828142814142828321e14142d141414321414501e1414145028142d14141432142d14281414145014142d14141e1e1e1450143228962814143232141e2d141e2d141e14282d14501e14143232141e1e14141e9632329614323214282d50141e1432141414143214282d32141414149614141e141428281414141e14142814141441141414141414321414141e2814142841412d141414282d50141428282d28141414141e1414141e14141414281414502d32142850321e1432141414284114141414149614142832281428142d3228502d1428281450415028142d143228501414321428321e14142814284114281414141e1441281414281414141414144114501414142d1e2d1e1428141414141432141e1e141414281428322d141450281e1e28281450322d1450142d1428413228281e2d1432322d1496962d141496962832141414142d1441961414321414322d2d1414141414281e32142d3214145014321414413228501414411414411e415014141414142d1e1e4114501e1441501414321414143214322d322d321414145032281414321414419614501432321428321e414150145014145014411e2d2814284132143214145014281432281414141414282d4128";
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (utils/Context.sol)

pragma solidity ^0.8.0;

/**
 * @dev Provides information about the current execution context, including the
 * sender of the transaction and its data. While these are generally available
 * via msg.sender and msg.data, they should not be accessed in such a direct
 * manner, since when dealing with meta-transactions the account sending and
 * paying for execution may not be the actual sender (as far as an application
 * is concerned).
 *
 * This contract is only required for intermediate, library-like contracts.
 */
abstract contract Context {
    function _msgSender() internal view virtual returns (address) {
        return msg.sender;
    }

    function _msgData() internal view virtual returns (bytes calldata) {
        return msg.data;
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (token/ERC721/utils/ERC721Holder.sol)

pragma solidity ^0.8.0;

import "../IERC721Receiver.sol";

/**
 * @dev Implementation of the {IERC721Receiver} interface.
 *
 * Accepts all token transfers.
 * Make sure the contract is able to use its token with {IERC721-safeTransferFrom}, {IERC721-approve} or {IERC721-setApprovalForAll}.
 */
contract ERC721Holder is IERC721Receiver {
    /**
     * @dev See {IERC721Receiver-onERC721Received}.
     *
     * Always returns `IERC721Receiver.onERC721Received.selector`.
     */
    function onERC721Received(
        address,
        address,
        uint256,
        bytes memory
    ) public virtual override returns (bytes4) {
        return this.onERC721Received.selector;
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (token/ERC721/IERC721Receiver.sol)

pragma solidity ^0.8.0;

/**
 * @title ERC721 token receiver interface
 * @dev Interface for any contract that wants to support safeTransfers
 * from ERC721 asset contracts.
 */
interface IERC721Receiver {
    /**
     * @dev Whenever an {IERC721} `tokenId` token is transferred to this contract via {IERC721-safeTransferFrom}
     * by `operator` from `from`, this function is called.
     *
     * It must return its Solidity selector to confirm the token transfer.
     * If any other value is returned or the interface is not implemented by the recipient, the transfer will be reverted.
     *
     * The selector can be obtained in Solidity with `IERC721.onERC721Received.selector`.
     */
    function onERC721Received(
        address operator,
        address from,
        uint256 tokenId,
        bytes calldata data
    ) external returns (bytes4);
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (access/Ownable.sol)

pragma solidity ^0.8.0;

import "../utils/Context.sol";

/**
 * @dev Contract module which provides a basic access control mechanism, where
 * there is an account (an owner) that can be granted exclusive access to
 * specific functions.
 *
 * By default, the owner account will be the one that deploys the contract. This
 * can later be changed with {transferOwnership}.
 *
 * This module is used through inheritance. It will make available the modifier
 * `onlyOwner`, which can be applied to your functions to restrict their use to
 * the owner.
 */
abstract contract Ownable is Context {
    address private _owner;

    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);

    /**
     * @dev Initializes the contract setting the deployer as the initial owner.
     */
    constructor() {
        _transferOwnership(_msgSender());
    }

    /**
     * @dev Returns the address of the current owner.
     */
    function owner() public view virtual returns (address) {
        return _owner;
    }

    /**
     * @dev Throws if called by any account other than the owner.
     */
    modifier onlyOwner() {
        require(owner() == _msgSender(), "Ownable: caller is not the owner");
        _;
    }

    /**
     * @dev Leaves the contract without owner. It will not be possible to call
     * `onlyOwner` functions anymore. Can only be called by the current owner.
     *
     * NOTE: Renouncing ownership will leave the contract without an owner,
     * thereby removing any functionality that is only available to the owner.
     */
    function renounceOwnership() public virtual onlyOwner {
        _transferOwnership(address(0));
    }

    /**
     * @dev Transfers ownership of the contract to a new account (`newOwner`).
     * Can only be called by the current owner.
     */
    function transferOwnership(address newOwner) public virtual onlyOwner {
        require(newOwner != address(0), "Ownable: new owner is the zero address");
        _transferOwnership(newOwner);
    }

    /**
     * @dev Transfers ownership of the contract to a new account (`newOwner`).
     * Internal function without access restriction.
     */
    function _transferOwnership(address newOwner) internal virtual {
        address oldOwner = _owner;
        _owner = newOwner;
        emit OwnershipTransferred(oldOwner, newOwner);
    }
}