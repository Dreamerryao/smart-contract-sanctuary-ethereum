/*                                                                                                    
                                       `..--:://///////::--..`             .:///////+-              
                                   .-://://///::::::::::::::://:-.`       //:----://.`              
                                .://::-:/::---------:::::/::::-::///:..  :+----://.                 
                             .://:---:/:-------------------:::/:::--:///:s---:/+-``                 
                          `-//:-----//-------------------------:://::--::/:::oo/////:.`             
                        `://::::::-::----------------------:::::::://:::::::/::::::::///            
                      `:+/:///::::::::::::-::::::::::::::::::::::::::::::::::::::::::://            
                     :+/://::::::::::::::::::::::::::::::::::::::::::::-/::::::o/----.              
                   .o/.`.--:::::://:::::::::::::::::+::::::://:::::----.`-/-````-/                  
                 `/+````````.-`../.```....:....-....+:-``````./.``````````./-``..-+.                
               `:/-:-.`````.-``../```````-````.````:+::```````./.````````..-/:::::-+-               
              :+::::::::---:``-`:-``````-.```..```.o/::-```````-:...---:::::-/::::::o.              
            `+::::::::::::/:-::-+--....-:....-...-/:/:::-..-----/::::::::::::-:::::::o              
           `o:-::::::::::/:-::://:-----/:::-::-:/:.`.-::--------:/:::::::::::-/:::::://             
           //--------::::/-://-..:-----+----:::-...```.----------+::::::::-----/------s             
           //-----------+--:-.`.+s+//--/---+ooooo+.`````.--------+:------------/------o.            
           .o----------:+-...-...:oso-./-..+so+/-`......``..-----+/-----:-----:/------o.            
            +/:/-:/:--/ssoyyhhhyo/:--..:``````-/osyyhhyyso+/////++/---:://:---/:--:---s             
            `o/::+++::+hdddhyyyyyhyo/:--.``-/ohddhhhhhddmmmmms-/+++:-:/++++:-:+---//://             
        `-:///::++s+o+yddo-+:++++oyy.`..-```/ysy/oo++oosyodddy-.+++o++++o+++/+/----+os              
         -:://+o+o:+++sho..o/////++:```````.:./o//////+os--yddh:`+++++oo+o++os:-----/+.             
             :s+o:--++:o/``+/:::/:.```````````:++::::/++- ./dy/.`-o++o/:-:/o+o+:------//-           
           :+::/+/--::-/.``-....-:````````````./---.---/:`.+:````:::/:-----:ooo:--------/+`         
        `:+::--:o:-----/.`.`......`````````````..````.--````````.:----------+o:----------:+:        
       -+::----/:------/``......````````````````.........``````.:-----------/o:-----------://       
      -+:::---/:-------/........`````````````````...........``.::-----------:++:--:------::-//      
      o:/y:--/::/------/........``````-oo-```````...........`-::-------------:o/--+:-----:/--+-     
     -+//o---//os------/.`....````````ss++:``````...........::--------------:-oo::o+:-----++::o     
     -++ +:--/oos/-----:/.````````````o++++-`````````.....::::://----------/+-oo+/oo:-----o/+:o.    
     `h. .o--:/ooo:-----:o:```````````+++++/````````````.::---oo:--------:/oo:oooooo/----:o :++-    
      -   //--:+/s+:-----oo+-.``....``:++++:``````..`````````/o/-------::+oos+ooosso+---:o`  os`    
           //:-:-oo+:----osoo+/-.`...-.----.``...:..-````..:+so:-----::+oosooooso-ho/--:+`   -s     
            .//::+.-+::--+y/ooo...`.``--.``.--....-.`::+syhysy/---::/+ooosyooso:  yo::+/            
              `-://  :+::/o  `+.```````.:-.:..```.```-hdhyhmdy:--:+oso/-.yos/.    y++/`             
                       -:++    +```````/ss::/-```````odyyhds..:::o/-`   /:.       +-                
                              /o-``````sdo./y/``````.hhyhds```-:``o                                 
                             -+`-::...-ydo`/yy+.``.-/:hyhh````````o`                                
                            :-.-.``----yds`:ss+:::-.`--+dy````-``:/                                 
                            `+```.....-ydh`+sss-::...```s+`````:/:                                  
                            -+.````````+dd:osss````````.-:.`````+.                                  
                            o.:````````yddhosss/``````````.-.`..+.                                  
                           -:..-``````:ddmmdhhhhs-``````````-``+-                                   
                           -:``-`````.-hddmmmhhhhd/``````````-`::                                   
                            +````````-.sdddmmmhhdmh:.........--o`                                   
                            ./``````..-hyyyyhdddddhs:.........hs                                    
                             .:-```..:yyyyyyyyhddhyyyo:.....-odd/                                   
                               .-----`yyyyyyyyyhhyyyyyy+--/ohhyyh/                                  
                                      yyyyyyyyyyyyyyyyyyyyyyyyyyyh-                                     
Customized Hibiki Fork

TG: @vtube_token

      +dddddddddddddddddhhyyhdmdddddmddddhhdddddddddddddhyso++++++syddddddddddddddddddddddddd+      
      +ddddddddddddddddhhhyyhdmdddddmmdddhhddddddddddyo:------------/sddddddddddddddddddddddd+      
      +ddddddddddddddddhhhyhhdmddddddddddhhdddddddds/-----------------:yddddddddddddddddddddd+      
      +ddddddddddddddddhhhyssyyyhddddddddhhddddddh/---------------------odmmmmmmmmmmmmmmmmmmm+      
      +ddddddddddddddddho/::----::/+sydddhhdddddy:-----------------------smmmmmmmmmmmmmmmmmmm+      
      +mmmmmmmmmmmmmddo:--------------/ohhhdmmmy:------------------------:ddddddddddddddddddd+      
      +dddddddddddddh/------------------:sdmmdy:-------:::---------------:ddddddddddddddddddd+      
      +ddddddddddddd/--------------::/+ooshhhhysoosssssyyo//:------------/ddddddddddddddddddd+      
      +mmmmmmmmmmmmh---------:/ooooossssssssssss/-syyssssyyysso+/::-----:hddddddddddddddddddd+      
      +dddddddddddmh-------:/osso/+sssssssssssss::syhysssssyyssssyss+:/ohdddddddddddddddddddd+      
      +mmmmmmmmmmmmm+----:osys+/+ssssssssssssss+-/s/.oyysssssssssssshysdddddddddddddddddddddd+      
      +dddddddddddddd+-/syss+:+sssssssssssssss+-:ss`  +yyssssssssssssyy++hmdddddddddddddddddd+      
      +dhhhhhhhhhhhdddhhsss:/osssssssssssssss+-:ss.    oysssssysssssssyyo-+hddddddddddddddddd+      
      +ddddddddddddddyysso:+ssssssssssssssss/-/ys.     .hssssshssssysssyys:-sdddddddddddddddd+      
      +mmmmmmmmmmmmhsysso:osssssssssssssss+::/so`       sssssysyssssysssyss--yddddddddddddddd+      
      +mmmmmmmmmmdyssyss/ssssssyysssssss+::::+-         +sssss`+ssssysssssso-/hhddddddddddddd+      
      +mmmmmmmmmdyssyss+ssssyyhyysssso+:::.--`      `.--ossss- `ssssyssssyss/-ysydddddddddddd+      
      +mdddddddmysssysossyyyyysssso+//:-````        ``..yyyy/.` -sssyssssysss-sssyddddddddddd+      
      +dddddddddsyssyssyyysssoo+/::-.``                -yso.``.-.sssyssssysss:ssssydddddddddd+      
      +ddddddhhhsyyyyyyyss+//:-..``                 ```os/`     `osyyssssysso/yssssyddddddddd+      
      +ddddddsyyyhsyhssoo+`   `                  ```..:/.        /syysssysss++yssssshdmdddddd+      
      +dddddysyysyshdss.-```.-//++/`            .+ssyyyys+/-`    /s:ysssssss+sysssssyhdmmmmmm+      
      +ddddhsysysyydd+s`-+yhddddh//-            -:-:sdddddddhs/` o..yssyssss/ysssssssyhmmmmmm+      
      +dddhyhyssyyhdo`oyyhddddhyys                 /ysyhhhhddohho- -ysysssss:ysssssssyydddddd+      
      +dddydmysssydd/oh+ sysshy/:s.                s:--yss/+h.`oys.:shssssso:yssssssssyyddddd+      
      +ddhdmhysssshd::s  .o..--.:s                 -o`..-..++  `s+./+ysssss+/sssssssssyshhhhh+      
      +dddddoosssssd- `    `:::/-                    .////+-   `-  -yssssss:ossssssssssyydddd+      
      +ddmmd/syysssso.                  `                      `  /sssssss+-yssssssssssyshmmm+      
      +dmmdd/sssyyssss+-.                              `````   ./sssssssss:oyssssssssssshyddd+      
      +ddddh:sssyhy+////:.```          `....`       `` ````.-/ossssssssyy+/dssssssssssssdyhdd+      
      +ddddh:ssshsy    ```````       `:.````.::`   ````./+ossssssyyyyyyso:+sssssssssssssddhdd+      
      +mmddh:ssshso     `````       `+:::::::-:/.   ````.--::::-/yssssss/+`-yssssssssssshdddd+      
      +ddddh:ssyyss                 ::----------+     ```````  `ossssss//. /sssssssssssshdddd+      
      +ddhhh:ssyssy:                ./----------+              :ssssss//-`/sosssssssssssdmmmm+      
      +dhhhs/osysssy/`               `-:::::::-:.             -ysssss/+//ohy+sssssssssssdmmmm+      
      +dddh:++syssysys:`                     `-:`            .ssssso:oyyssyy:sssssssssssddmmm+      
      +hddy-o/syshysssys+:``                               `:ysssso:ossssssh-ossssssssssdddmm+      
      +hddo:s/syydhssssssyys+:.`                        `-+yhssss//ssssssssh-+ssssssssssddddd+      
      +dhh:+sooydhhssssssyssssyysoo+:            .:/+osyyyyyssso:+sysssssssy:/ssssssssssddddd+      
      +dyy-ssy/smddsssssshsssssyyo-+d`           oh-.oysshssso/+yssysssssssso:sssssssssshddhd+      
      +mh//ssssodddssssssdsssyo:` +++            -++  .yhsso//ssssshsssssssss-ossssssssshddhd+      
      +dd+osssyshddysssssdyo:`   `/               ./ `osso+/sysssssdysssssssy:/ssssssssshmhdd+      
      /hh+ssssddydmysssys/.      -`               /-/sso+/:`./oysssdhsssssssso-ssssssssshhhdd+      
      +dd+ssshddddmhssy--        /               `ysso/:.`   `-.+hsddssssssssy:+ssssssssyyddd+      
      +dy+ssshddddddsss ..       o```.````     `:so/-``     `.` -hymmhssssssss+:sssssssssdmdd+      
      +doossyydddddmhyo- .`      s----..--::-.:+y-`        ..` .+/ymmdsssssssss:osssssssydddd+      
      +h+sshdsdddmmmh. :-`.`     o.......````.:o.        ... `::` .hmmhssssssss+/sssssssshddd+      
      +h+syddhhddmmd-   .-``.`   :-   ``````.:/`      ``.` `.:.    -dmmyssssssss/ossssssyshdd+      
      +hosddddhdddd+     `+-``..``+`  .`   `:-    ``..````--.       sdddyssssssss/ssssssdysdd+      
      +yoyhhddhdddh`     -..--``..-+  .  `:-````..``` .--o`         /ddhhssssssssoosssssddshm+      
      +yshddddddddo      /    .-:-`-/.`.//-.`````.---..  -.         .ddddhsssssssyosssssdmysd+      
      +ssddddddddd/     `-  `+ossssyyssyooooooo-.`        /          ymdddhssssssshossssddhsh+     
      
 */

// SPDX-License-Identifier: MIT
pragma solidity >=0.8.0 <0.9.0;

import "./Auth.sol";
import "./IBEP20.sol";
import "./IDexRouter.sol";
import "./IDexFactory.sol";
import "./SafeMath.sol";

contract VTube is IBEP20, Auth {
    using SafeMath for uint256;

    address DEAD = 0x000000000000000000000000000000000000dEaD;
    address ZERO = 0x0000000000000000000000000000000000000000;

    string constant _name = "VTube Token";
    string constant _symbol = "VTUBE";
    uint8 constant _decimals = 18;

    uint256 _totalSupply = 36_000_000 * (10**_decimals);

    mapping(address => uint256) _balances;
    mapping(address => mapping(address => uint256)) _allowances;
    mapping(address => bool) isFeeExempt;

    // Fees. Some may be completely inactive at all times.
    uint256 liquidityFee = 30;
    uint256 burnFee = 0;
    uint256 stakingFee = 20;

    uint256 feeDenominator = 1000;
    bool public feeOnNonTrade = false;

    //Percentage of regular fee to be applied on selling
    uint256 sellFactor = 100;

    uint256 public stakingPrizePool = 0;
    bool public stakingRewardsActive = false;
    address public stakingRewardsContract;

    address public autoLiquidityReceiver;

    IDexRouter public router;
    address pcs2BNBPair;
    address[] public pairs;

    bool public swapEnabled = true;
    uint256 public swapThreshold = _totalSupply / 20000;
    bool inSwap;
    modifier swapping() {
        inSwap = true;
        _;
        inSwap = false;
    }

    uint256 public launchedAt = 0;

    event AutoLiquifyEnabled(bool enabledOrNot);
    event AutoLiquify(uint256 amountBNB, uint256 autoBuybackAmount);
    event StakingRewards(bool activate);

    constructor() Auth(msg.sender) {
        //router = IDexRouter(0x9Ac64Cc6e4415144C455BD8E4837Fea55603e5c3);
        router = IDexRouter(0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D);
        pcs2BNBPair = IDexFactory(router.factory()).createPair(
            router.WETH(),
            address(this)
        );
        _allowances[address(this)][address(router)] = type(uint256).max;

        isFeeExempt[msg.sender] = true;
        isFeeExempt[address(this)] = true;

        autoLiquidityReceiver = msg.sender;
        pairs.push(pcs2BNBPair);
        _balances[msg.sender] = _totalSupply;
        emit Transfer(address(0), msg.sender, _totalSupply);
    }

    receive() external payable {}

    function totalSupply() external view override returns (uint256) {
        return _totalSupply;
    }

    function decimals() external pure override returns (uint8) {
        return _decimals;
    }

    function symbol() external pure override returns (string memory) {
        return _symbol;
    }

    function name() external pure override returns (string memory) {
        return _name;
    }

    function getOwner() external view override returns (address) {
        return owner;
    }

    function balanceOf(address account) public view override returns (uint256) {
        return _balances[account];
    }

    function allowance(address holder, address spender)
        external
        view
        override
        returns (uint256)
    {
        return _allowances[holder][spender];
    }

    function approve(address spender, uint256 amount)
        public
        override
        returns (bool)
    {
        _allowances[msg.sender][spender] = amount;
        emit Approval(msg.sender, spender, amount);
        return true;
    }

    function approveMax(address spender) external returns (bool) {
        return approve(spender, type(uint256).max);
    }

    function transfer(address recipient, uint256 amount)
        external
        override
        returns (bool)
    {
        return _transferFrom(msg.sender, recipient, amount);
    }

    function transferFrom(
        address sender,
        address recipient,
        uint256 amount
    ) external override returns (bool) {
        if (_allowances[sender][msg.sender] != type(uint256).max) {
            require(
                _allowances[sender][msg.sender] >= amount,
                "Insufficient Allowance"
            );
            _allowances[sender][msg.sender] -= amount;
        }

        return _transferFrom(sender, recipient, amount);
    }

    function _isStakingReward(address sender, address recipient)
        internal
        view
        returns (bool)
    {
        return
            sender == stakingRewardsContract ||
            recipient == stakingRewardsContract;
    }

    function _transferFrom(
        address sender,
        address recipient,
        uint256 amount
    ) internal returns (bool) {
        require(amount > 0);
        if (inSwap || _isStakingReward(sender, recipient)) {
            return _basicTransfer(sender, recipient, amount);
        }

        if (shouldSwapBack()) {
            liquify();
        }

        if (!launched() && recipient == pcs2BNBPair) {
            require(_balances[sender] > 0);
            require(
                sender == owner,
                "Only the owner can be the first to add liquidity."
            );
            launch();
        }

        require(amount <= _balances[sender], "Insufficient Balance");
        _balances[sender] -= amount;

        uint256 amountReceived = shouldTakeFee(sender, recipient)
            ? heSold(recipient)
                ? takeFee(sender, amount, sellFactor)
                : takeFee(sender, amount, 100)
            : amount;
        _balances[recipient] += amountReceived;

        // Update staking pool, if active.
        // Update of the pool can be deactivated for launch and staking contract migration.
        if (stakingRewardsActive) {
            sendToStakingPool();
        }

        emit Transfer(sender, recipient, amountReceived);
        return true;
    }

    function _basicTransfer(
        address sender,
        address recipient,
        uint256 amount
    ) internal returns (bool) {
        require(amount <= _balances[sender], "Insufficient Balance");
        _balances[sender] -= amount;
        _balances[recipient] += amount;
        emit Transfer(sender, recipient, amount);
        return true;
    }

    // Decides whether this trade should take a fee.
    // Trades with pairs are always taxed, unless sender or receiver is exempted.
    // Non trades, like wallet to wallet, are configured, untaxed by default.
    function shouldTakeFee(address sender, address recipient)
        internal
        view
        returns (bool)
    {
        if (isFeeExempt[sender] || isFeeExempt[recipient] || !launched()) {
            return false;
        }

        address[] memory liqPairs = pairs;
        for (uint256 i = 0; i < liqPairs.length; i++) {
            if (sender == liqPairs[i] || recipient == liqPairs[i]) {
                return true;
            }
        }

        return feeOnNonTrade;
    }

    function heSold(address recipient) internal view returns (bool) {
        address[] memory liqPairs = pairs;
        for (uint256 i = 0; i < liqPairs.length; i++) {
            if (recipient == liqPairs[i]) {
                return true;
            }
        }
        return false;
    }

    function takeFee(
        address sender,
        uint256 amount,
        uint256 factor
    ) internal returns (uint256) {
        if (!launched()) {
            return amount;
        }
        uint256 liqFee = 0;
        uint256 bf = 0;
        uint256 steak = 0;

        // If there is a liquidity tax active for autoliq, the contract keeps it.
        if (liquidityFee > 0) {
            liqFee = (amount * liquidityFee) / feeDenominator;
            liqFee = withPercent(liqFee, factor);
            _balances[address(this)] += liqFee;
            emit Transfer(sender, address(this), liqFee);
        }
        // If there is an active burn fee, burn a percentage and give it to dead address.
        if (burnFee > 0) {
            bf = (amount * burnFee) / feeDenominator;
            bf = withPercent(bf, factor);
            _balances[DEAD] += bf;
            emit Transfer(sender, DEAD, bf);
        }
        // If staking tax is active, it is stored on ZERO address.
        // If staking payout itself is active, it is later moved from ZERO to the appropriate staking address.
        if (stakingFee > 0) {
            steak = (amount * stakingFee) / feeDenominator;
            steak = withPercent(steak, factor);
            _balances[ZERO] += steak;
            stakingPrizePool += steak;
            emit Transfer(sender, ZERO, steak);
        }

        return amount - liqFee - bf - steak;
    }

    function sendToStakingPool() internal {
        _balances[ZERO] -= stakingPrizePool;
        _balances[stakingRewardsContract] += stakingPrizePool;
        emit Transfer(ZERO, stakingRewardsContract, stakingPrizePool);
        stakingPrizePool = 0;
    }

    function setStakingRewardsAddress(address addy) external authorized {
        stakingRewardsContract = addy;
        isFeeExempt[addy] = true;
    }

    function shouldSwapBack() internal view returns (bool) {
        return
            launched() &&
            msg.sender != pcs2BNBPair &&
            !inSwap &&
            swapEnabled &&
            _balances[address(this)] >= swapThreshold;
    }

    function setSwapEnabled(bool set) external authorized {
        swapEnabled = set;
        emit AutoLiquifyEnabled(set);
    }

    function liquify() internal swapping {
        uint256 amountToLiquify = swapThreshold / 2;
        uint256 balanceBefore = address(this).balance;

        address[] memory path = new address[](2);
        path[0] = address(this);
        path[1] = router.WETH();

        router.swapExactTokensForETHSupportingFeeOnTransferTokens(
            amountToLiquify,
            0,
            path,
            address(this),
            block.timestamp
        );

        uint256 amountBNB = address(this).balance - balanceBefore;
        uint256 amountBNBLiquidity = amountBNB / 2;

        router.addLiquidityETH{value: amountBNBLiquidity}(
            address(this),
            amountToLiquify,
            0,
            0,
            autoLiquidityReceiver,
            block.timestamp
        );
        emit AutoLiquify(amountBNBLiquidity, amountToLiquify);
    }

    function launched() internal view returns (bool) {
        return launchedAt != 0;
    }

    function launch() internal {
        launchedAt = block.number;
    }

    function setIsFeeExempt(address holder, bool exempt) external authorized {
        isFeeExempt[holder] = exempt;
    }

    function setFees(
        uint256 _liquidityFee,
        uint256 _burnFee,
        uint256 _stakingFee,
        uint256 _feeDenominator
    ) external authorized {
        liquidityFee = _liquidityFee;
        burnFee = _burnFee;
        stakingFee = _stakingFee;

        feeDenominator = _feeDenominator;
        uint256 totalFee = _liquidityFee + _burnFee + _stakingFee;
        require(
            totalFee < feeDenominator / 5,
            "Maximum allowed taxation on this contract is 20%."
        );
    }

    function setSellFactor(uint256 _sellFactor) external authorized {
        require(
            _sellFactor >= 100 && _sellFactor <= 300,
            "Selling factor can never be less than 100% and never greater than 300%"
        );
        sellFactor = _sellFactor;
    }

    function withPercent(uint256 _total, uint256 _percentage)
        internal
        pure
        returns (uint256)
    {
        return _total.mul(_percentage).div(100);
    }

    function setLiquidityReceiver(address _autoLiquidityReceiver)
        external
        authorized
    {
        autoLiquidityReceiver = _autoLiquidityReceiver;
    }

    function getCirculatingSupply() public view returns (uint256) {
        return
            _totalSupply - balanceOf(DEAD) - balanceOf(ZERO) + stakingPrizePool;
    }

    // Recover any BNB sent to the contract by mistake.
    function resuce() external {
        payable(owner).transfer(address(this).balance);
    }

    function setStakingRewardsActive(bool active) external authorized {
        stakingRewardsActive = active;
        emit StakingRewards(active);
    }

    function addPair(address pair) external authorized {
        pairs.push(pair);
    }

    function removeLastPair() external authorized {
        pairs.pop();
    }
}