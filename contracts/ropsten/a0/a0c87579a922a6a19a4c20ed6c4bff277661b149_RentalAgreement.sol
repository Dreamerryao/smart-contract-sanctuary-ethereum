pragma solidity ^0.4.24; library SafeMath { function mul(uint256 a, uint256 b) internal pure returns (uint256) { uint256 c = a * b; assert(a == 0 || c / a == b); return c; } function div(uint256 a, uint256 b) internal pure returns (uint256) { uint256 c = a / b; return c; } function sub(uint256 a, uint256 b) internal pure returns (uint256) { assert(b <= a); return a - b; } function add(uint256 a, uint256 b) internal pure returns (uint256) { uint256 c = a + b; assert(c >= a && c >= b); return c; } } interface notifier { function approved() external; function deposit(uint256 amount) external; function withdraw(uint256 amount) external; function rentModified(uint256 amount) external; function ticket(bool ticketOpen) external; function dispute(bool ongGoing) external; function admin(address user) external returns (bool); } contract RentalAgreement { using SafeMath for uint256; struct lastAmount{ uint256 amount; uint256 timestamp; uint256 blockNumber; } struct lastTicket{ bool ticketOpen; uint256 timestamp; uint256 blockNumber; } struct lastDispute{ bool onGoingDispute; address disputeStartedBy; uint256 timestamp; uint256 blockNumber; } lastAmount public lastDepositInfo; lastAmount public lastWithdrawalInfo; lastAmount public lastRentModificationInfo; lastTicket public lastTicketInfo; lastDispute public lastDisputeInfo; notifier public Notifier; address public landlord; address public tenant; uint256 public rent; bool public agreementApproved; uint256 public lockedAmount; uint256 public availableAmount; bool public ticketOpen; bool public onGoingDispute; address public disputeStartedBy; /*-----Rental Agreement Clauses start here-----*/ /*General*/ uint256 public selectedPropertyID = 2; string public selectedCountry ='CAN'; uint256 public selectedStateID = 0; uint256 public dateLeaseStarts = 1532564266; uint256 public leaseDateSelected = 2; uint256 public dateLeaseEnds = 0; uint256 public renewalSelected = 2; /*Property*/ uint256 public selectedAccessToParking = 2; /*Parties*/ uint256 public selectedOccupantsOptions = 2; /*Terms*/ uint256 public selectedRentFrequency = 3; uint256 public rentAgreed = 560000000000000000; uint256 public paymentDateDay = 15; uint256 public paymentDateMonth = 0; uint256 public selectedincrementNotice = 2; uint256 public daysNoticeBeforeIncreasingRent = 45; uint256 public selectedPetsAllowance = 4; uint256 public selectedSmokingAllowance = 3; uint256 public selectedLatePayment = 2; uint256 public latePaymentAmount = 50; uint256 public selectedUtilitiesDetails = 3; uint256 public electricity = 1; uint256 public water_sewer = 2; uint256 public internet = 2; uint256 public cable = 1; uint256 public telephone = 2; uint256 public naturalGas = 3; uint256 public heatingOil_propane = 2; uint256 public garbageCollection = 1; uint256 public alarm_securitySystem = 2; /*Final details*/ uint256 public selectedDisputeResolution = 4; uint256 public selectedDisputeResolutionCost = 1; uint256 public selectedAdditionalClause = 2; event Approved(address user, uint256 timestamp); event Deposit(address user, uint256 amount, uint256 timestamp); event Withdraw(address user, uint256 amount, uint256 timestamp); event RentModified(address user, uint256 amount, uint256 timestamp); event Ticket(address user, bool open, uint256 timestamp); event Dispute(address user, bool ongGoing, uint256 timestamp); constructor() public { Notifier = notifier(0x47A02DF5fD5BAe15b6b4Dd69201b5a178A4D5bC6); /*Event notifier*/ landlord = msg.sender; /*Landlord's address*/ tenant = 0x00de09b417fe66e934754fefb87c9695a6e2e32b; /*Tenant's address*/ rent = 560000000000000000; /*rent amount*/ } /*Tenant approves this this agreement*/ function approveAgreement() public { require(msg.sender == tenant); agreementApproved = true; Notifier.approved(); emit Approved(msg.sender, now); } /*The smart contract won't process any action until Tenant Approves the Rental Agreement*/ modifier rentalAgreementApproved { require(agreementApproved); _; } /*Tenant deposits the rent*/ function deposit() payable rentalAgreementApproved public { uint256 amount = msg.value; lastDepositInfo = lastAmount({amount:amount, timestamp:now, blockNumber:block.number}); if(ticketOpen){ lockedAmount = lockedAmount.add(amount); }else{ availableAmount = availableAmount.add(amount); } Notifier.deposit(amount); emit Deposit(msg.sender, amount, now); } /*Send funds to the contract address so it can process the deposit*/ function () payable public { deposit(); } /*Withdraw the money paid*/ function withdraw() rentalAgreementApproved public { require(msg.sender == landlord); uint256 amount = availableAmount; availableAmount = 0; lastWithdrawalInfo = lastAmount({amount:amount, timestamp:now, blockNumber:block.number}); msg.sender.transfer(amount); Notifier.withdraw(amount); emit Withdraw(msg.sender, amount, now); } /*Increase/Decrease the rent*/ function modifyRent(uint256 newRent) rentalAgreementApproved public { require(msg.sender == landlord); rent = newRent; lastRentModificationInfo = lastAmount({amount:rent, timestamp:now, blockNumber:block.number}); Notifier.rentModified(rent); emit RentModified(msg.sender, rent, now); } /*Open a ticket*/ function openTicket() rentalAgreementApproved public { require(msg.sender == tenant); require(!ticketOpen); ticketOpen = true; lastTicketInfo = lastTicket({ticketOpen:ticketOpen, timestamp:now, blockNumber:block.number}); Notifier.ticket(ticketOpen); emit Ticket(msg.sender, ticketOpen, now); } /*Close the ticket*/ function closeTicket() public { require(msg.sender == tenant || Notifier.admin(msg.sender)); require(ticketOpen); ticketOpen = false; lastTicketInfo = lastTicket({ticketOpen:ticketOpen, timestamp:now, blockNumber:block.number}); uint256 amount = lockedAmount; lockedAmount = 0; availableAmount = availableAmount.add(amount); Notifier.ticket(ticketOpen); emit Ticket(msg.sender, ticketOpen, now); } /*Start dispute*/ function startDispute() rentalAgreementApproved public { require(!onGoingDispute); require(Notifier.admin(msg.sender) || msg.sender == landlord || msg.sender == tenant); disputeStartedBy = msg.sender; onGoingDispute = true; lastDisputeInfo = lastDispute({onGoingDispute:onGoingDispute,disputeStartedBy:disputeStartedBy,timestamp:now, blockNumber:block.number}); Notifier.dispute(onGoingDispute); emit Dispute(msg.sender, onGoingDispute, now); } /*End dispute*/ function endDispute() public { require(onGoingDispute); require(msg.sender == disputeStartedBy || Notifier.admin(msg.sender)); onGoingDispute = false; lastDisputeInfo = lastDispute({onGoingDispute:onGoingDispute,disputeStartedBy:disputeStartedBy,timestamp:now, blockNumber:block.number}); disputeStartedBy = 0x0; Notifier.dispute(onGoingDispute); emit Dispute(msg.sender, onGoingDispute, now); } /*Methods to get contract variables start here*/ function viewFirstLotOfContractState() public view returns(uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256){ return(lastDepositInfo.amount,lastDepositInfo.timestamp,lastDepositInfo.blockNumber, lastWithdrawalInfo.amount,lastWithdrawalInfo.timestamp,lastWithdrawalInfo.blockNumber, lastRentModificationInfo.amount,lastRentModificationInfo.timestamp,lastRentModificationInfo.blockNumber); } function viewSecondLotOfContractState() public view returns(bool,uint256,uint256,bool,address,uint256,uint256,uint256,uint256,uint256){ return(lastTicketInfo.ticketOpen,lastTicketInfo.timestamp,lastTicketInfo.blockNumber, lastDisputeInfo.onGoingDispute,lastDisputeInfo.disputeStartedBy,lastDisputeInfo.timestamp,lastDisputeInfo.blockNumber, lockedAmount,availableAmount,rent); } function viewMostRelevantClauses() public view returns(uint256,string,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256){ return (selectedPropertyID, selectedCountry, selectedStateID, selectedRentFrequency, paymentDateDay, paymentDateMonth, dateLeaseStarts, leaseDateSelected, dateLeaseEnds, renewalSelected); } function viewFirstLotOfClauses() public view returns(uint256,string,uint256,uint256,uint256,uint256,uint256,uint256){ return (selectedPropertyID, selectedCountry, selectedStateID, dateLeaseStarts, leaseDateSelected, dateLeaseEnds, renewalSelected, selectedAccessToParking); } function viewSecondLotOfClauses() public view returns(uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256){ return (selectedOccupantsOptions, selectedRentFrequency, rentAgreed, paymentDateDay, paymentDateMonth, selectedincrementNotice, daysNoticeBeforeIncreasingRent, selectedPetsAllowance); } function viewThirdLotOfClauses() public view returns(uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256){ return (selectedSmokingAllowance, selectedLatePayment, latePaymentAmount, selectedUtilitiesDetails, electricity, water_sewer, internet, cable); } function viewFourthLotOfClauses() public view returns(uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256){ return (telephone, naturalGas, heatingOil_propane, garbageCollection, alarm_securitySystem, selectedDisputeResolution, selectedDisputeResolutionCost, selectedAdditionalClause); } }